<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeuspotifyServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Deuspotify</a> &gt; <a href="index.source.html" class="el_package">com.deusto.deuspotify.services</a> &gt; <span class="el_source">DeuspotifyServiceImpl.java</span></div><h1>DeuspotifyServiceImpl.java</h1><pre class="source lang-java linenums">package com.deusto.deuspotify.services;

import com.deusto.deuspotify.model.Song;
import com.deusto.deuspotify.model.Playlist;
import com.deusto.deuspotify.repositories.SongRepository;
import com.deusto.deuspotify.repositories.PlaylistRepository;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.*;
import java.util.*;
import java.util.stream.Collectors;

/**
 * Implementation of the DeuspotifyService interface providing the core business logic
 * for managing songs and playlists in the application.
 */
@Service
public class DeuspotifyServiceImpl implements DeuspotifyService {

    private final SongRepository songRepository;
    private final PlaylistRepository playlistRepository;

<span class="fc" id="L25">    private final String uploadDir = &quot;uploads/songs&quot;;</span>

    /**
     * Constructor injecting required repositories.
     *
     * @param songRepository the song repository
     * @param playlistRepository the playlist repository
     */
<span class="fc" id="L33">    public DeuspotifyServiceImpl(SongRepository songRepository, PlaylistRepository playlistRepository) {</span>
<span class="fc" id="L34">        this.songRepository = songRepository;</span>
<span class="fc" id="L35">        this.playlistRepository = playlistRepository;</span>
<span class="fc" id="L36">    }</span>

    // ===================== SONGS =====================

    /**
     * Retrieves all songs stored in the database.
     *
     * @return list of all songs
     */
    @Override
    public List&lt;Song&gt; retrieveAllSongs() {
<span class="fc" id="L47">        return songRepository.findAll();</span>
    }

    /**
     * Finds a specific song by ID.
     *
     * @param id the song ID
     * @return optional of song if found
     */
    @Override
    public Optional&lt;Song&gt; findSong(Long id) {
<span class="fc" id="L58">        return songRepository.findById(id);</span>
    }

    /**
     * Adds a new song to the database.
     *
     * @param song the song to add
     * @return the saved song
     */
    @Override
    public Song addSong(Song song) {
<span class="nc" id="L69">        return songRepository.save(song);</span>
    }

    /**
     * Updates an existing song by ID.
     *
     * @param id the ID of the song to update
     * @param song the song with updated fields
     * @return the updated song
     */
    @Override
    public Song updateSong(Long id, Song song) {
<span class="nc" id="L81">        song.setId(id);</span>
<span class="nc" id="L82">        return songRepository.save(song);</span>
    }

    /**
     * Deletes a song by its ID and removes it from all playlists that contain it.
     *
     * @param id the ID of the song to delete
     */
    @Override
    public void deleteSong(Long id) {
<span class="nc" id="L92">        List&lt;Playlist&gt; playlists = playlistRepository.findAll();</span>
<span class="nc" id="L93">        Optional&lt;Song&gt; songOpt = songRepository.findById(id);</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (songOpt.isPresent()) {</span>
<span class="nc" id="L96">            Song song = songOpt.get();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            for (Playlist playlist : playlists) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (playlist.getSongs().contains(song)) {</span>
<span class="nc" id="L99">                    playlist.getSongs().remove(song);</span>
<span class="nc" id="L100">                    playlistRepository.save(playlist);</span>
                }
<span class="nc" id="L102">            }</span>
<span class="nc" id="L103">            songRepository.delete(song);</span>
<span class="nc" id="L104">        } else {</span>
<span class="nc" id="L105">            throw new RuntimeException(&quot;Song not found&quot;);</span>
        }
<span class="nc" id="L107">    }</span>

    /**
     * Adds a new song and saves an audio file to the server.
     *
     * @param name the song name
     * @param album the album name
     * @param artists comma-separated list of artists
     * @param genres comma-separated list of genres
     * @param duration the song duration in seconds
     * @param dateOfRelease the release date of the song
     * @param file the audio file
     * @return the saved song
     */
    @Override
    public Song addSongWithFile(String name, String album, String artists, String genres,
                                double duration, Date dateOfRelease, MultipartFile file) {
<span class="pc bpc" id="L124" title="2 of 4 branches missed.">        if (file.getContentType() == null || !file.getContentType().startsWith(&quot;audio/&quot;)) {</span>
<span class="nc" id="L125">            throw new IllegalArgumentException(&quot;Only audio files are allowed&quot;);</span>
        }

<span class="fc" id="L128">        String originalFilename = file.getOriginalFilename();</span>
<span class="pc bpc" id="L129" title="2 of 4 branches missed.">        if (originalFilename == null || !originalFilename.toLowerCase().matches(&quot;.*\\.(mp3|wav|ogg|flac)$&quot;)) {</span>
<span class="nc" id="L130">            throw new IllegalArgumentException(&quot;Invalid audio file extension&quot;);</span>
        }

        try {
<span class="fc" id="L134">            Files.createDirectories(Paths.get(uploadDir));</span>
<span class="fc" id="L135">            String cleanedFilename = System.currentTimeMillis() + &quot;_&quot; + originalFilename.replaceAll(&quot;[^a-zA-Z0-9.\\-]&quot;, &quot;_&quot;);</span>
<span class="fc" id="L136">            Path filePath = Paths.get(uploadDir, cleanedFilename);</span>
<span class="fc" id="L137">            Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);</span>

<span class="fc" id="L139">            Song song = new Song(name, Arrays.asList(artists.split(&quot;\\s*,\\s*&quot;)), duration,</span>
<span class="fc" id="L140">                    Arrays.asList(genres.split(&quot;\\s*,\\s*&quot;)), dateOfRelease, album, cleanedFilename);</span>

<span class="fc" id="L142">            return songRepository.save(song);</span>
<span class="nc" id="L143">        } catch (IOException e) {</span>
<span class="nc" id="L144">            throw new RuntimeException(&quot;Error saving file&quot;, e);</span>
        }
    }

    /**
     * Creates a copy of an existing song intended for sharing.
     *
     * @param name the song name
     * @param album the album
     * @param artists artists list
     * @param genres genres list
     * @param duration song duration
     * @param dateOfRelease release date
     * @param filePath path to the shared file
     * @return the new shared song
     */
    @Override
    public Song createSharedSong(String name, String album, String artists, String genres,
                                 double duration, Date dateOfRelease, String filePath) {
<span class="fc" id="L163">        Song sharedSong = new Song(name + &quot; Shared&quot;, Arrays.asList(artists.split(&quot;\\s*,\\s*&quot;)),</span>
<span class="fc" id="L164">                duration, Arrays.asList(genres.split(&quot;\\s*,\\s*&quot;)), dateOfRelease, album, filePath);</span>
<span class="fc" id="L165">        return songRepository.save(sharedSong);</span>
    }

    // ===================== PLAYLISTS =====================

    /**
     * Retrieves all playlists in the system.
     *
     * @return list of all playlists
     */
    @Override
    public List&lt;Playlist&gt; retrieveAllPlaylists() {
<span class="fc" id="L177">        return playlistRepository.findAll();</span>
    }

    /**
     * Finds a playlist by its ID.
     *
     * @param id the playlist ID
     * @return optional playlist if found
     */
    @Override
    public Optional&lt;Playlist&gt; findPlaylist(Long id) {
<span class="fc" id="L188">        return playlistRepository.findById(id);</span>
    }

    /**
     * Adds a new playlist to the system.
     *
     * @param playlist the playlist to add
     * @return the saved playlist
     */
    @Override
    public Playlist addPlaylist(Playlist playlist) {
<span class="fc" id="L199">        return playlistRepository.save(playlist);</span>
    }

    /**
     * Updates an existing playlist, applying order rules if specified.
     *
     * @param id the ID of the playlist to update
     * @param playlist the updated playlist object
     * @return the updated playlist
     */
    @Override
    public Playlist updatePlaylist(Long id, Playlist playlist) {
<span class="fc" id="L211">        playlist.setId(id);</span>

<span class="pc bpc" id="L213" title="2 of 4 branches missed.">        if (playlist.getSongs() != null &amp;&amp; playlist.getOrder() != null) {</span>
<span class="fc" id="L214">            String orderType = playlist.getOrderType();</span>

<span class="fc bfc" id="L216" title="All 2 branches covered.">            if (&quot;duration&quot;.equalsIgnoreCase(orderType)) {</span>
<span class="fc" id="L217">                playlist.getSongs().sort((s1, s2) -&gt; Double.compare(s2.getDuration(), s1.getDuration()));</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">            } else if (&quot;release_date&quot;.equalsIgnoreCase(orderType)) {</span>
<span class="fc" id="L219">                playlist.getSongs().sort((s1, s2) -&gt; {</span>
<span class="pc bpc" id="L220" title="2 of 4 branches missed.">                    if (s1.getDateOfRelease() == null || s2.getDateOfRelease() == null) {</span>
<span class="nc" id="L221">                        return 0;</span>
                    }
<span class="fc" id="L223">                    return s2.getDateOfRelease().compareTo(s1.getDateOfRelease());</span>
                });
            }
        }

<span class="fc" id="L228">        return playlistRepository.save(playlist);</span>
    }

    /**
     * Deletes a playlist by ID.
     *
     * @param id the playlist ID
     */
    @Override
    public void deletePlaylist(Long id) {
<span class="nc" id="L238">        playlistRepository.deleteById(id);</span>
<span class="nc" id="L239">    }</span>

    /**
     * Finds a list of songs by their IDs.
     *
     * @param songIds list of song IDs
     * @return list of found songs
     */
    @Override
    public List&lt;Song&gt; findSongsByIds(List&lt;Long&gt; songIds) {
<span class="fc" id="L249">        return songRepository.findAllById(songIds);</span>
    }

    /**
     * Updates the list of songs in a playlist.
     *
     * @param playlistId the ID of the playlist
     * @param songIds the new list of song IDs
     * @return the updated playlist
     */
    @Override
    public Playlist updatePlaylistSongs(Long playlistId, List&lt;Long&gt; songIds) {
<span class="nc" id="L261">        Optional&lt;Playlist&gt; playlistOptional = playlistRepository.findById(playlistId);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (!playlistOptional.isPresent()) {</span>
<span class="nc" id="L263">            throw new RuntimeException(&quot;Playlist not found&quot;);</span>
        }

<span class="nc" id="L266">        Playlist playlist = playlistOptional.get();</span>
<span class="nc" id="L267">        List&lt;Song&gt; songs = findSongsByIds(songIds);</span>
<span class="nc" id="L268">        playlist.setSongs(songs);</span>

<span class="nc" id="L270">        return playlistRepository.save(playlist);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>