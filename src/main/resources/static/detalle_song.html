<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title data-i18n="songDetail.title">Detalle de la Canción</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="side-layout">
    <div style="position: absolute; top: 10px; right: 20px;">
        <button onclick="loadTranslations('es')" title="Español">Es</button>
        <button onclick="loadTranslations('en')" title="English">En</button>
        <button onclick="loadTranslations('eu')" title="Euskara">Eu</button>
      </div>
    <div class="main-content">
        <h2 data-i18n="songDetail.heading">Detalles de la Canción</h2>
        <div id="songDetails"></div>
        <br>
        <button id="editBtn" data-i18n="songDetail.edit">Editar</button>
        <button id="deleteBtn" data-i18n="songDetail.delete">Eliminar</button>
        <button onclick="window.location.href='songs.html'" data-i18n="songDetail.back">Volver</button>
        <button id="shareBtn" data-i18n="songDetail.share">Compartir</button>
    </div>

    <script src="i18n.js"></script>
    <script>
    const full = window.location.origin;
    const match = full.match(/^(https?:\/\/[^\/:]+)/);
    const appUrl = match ? match[0] : '';
        const params = new URLSearchParams(window.location.search);
        const songId = params.get('id');

        if (!songId) {
            document.getElementById("songDetails").innerText = t("songDetail.error");
        } else {
            fetch(`${appUrl || "http://localhost"}:8080/api/songs/${songId}`)
                .then(res => res.json())
                .then(song => {
                    const container = document.getElementById("songDetails");
                    let audioPlayer = "";
                    if (song.filePath) {
                        audioPlayer = `<audio controls>
                                         <source src="/songs_files/${song.filePath}" type="audio/mpeg">
                                       </audio>`;
                    }
                    container.innerHTML = `
                        <p><strong data-i18n="songDetail.name">Nombre:</strong> ${song.name}</p>
                        <p><strong data-i18n="songDetail.artists">Artistas:</strong> ${song.artists.join(', ')}</p>
                        <p><strong data-i18n="songDetail.duration">Duración:</strong> ${song.duration} minutos</p>
                        <p><strong data-i18n="songDetail.genres">Géneros:</strong> ${song.genres.join(', ')}</p>
                        <p><strong data-i18n="songDetail.releaseDate">Fecha de Lanzamiento:</strong> ${new Date(song.dateOfRelease).toLocaleDateString()}</p>
                        <p><strong data-i18n="songDetail.album">Álbum:</strong> ${song.album}</p>
                        ${audioPlayer}
                    `;

                    document.getElementById("editBtn").onclick = () => {
                        window.location.href = `edit_song.html?id=${song.id}`;
                    };

                    document.getElementById("deleteBtn").onclick = () => {
                        if (confirm(t('songDetail.confirmDelete'))) {
                          fetch(`${appUrl || "http://localhost"}:8080/api/songs/${song.id}`, {
                            method: "DELETE"
                          })
                          .then(response => {
                            if (!response.ok) {
                              throw new Error(t('songDetail.deleteError')); 
                            }
                            alert(t('songDetail.deleteSuccess'));
                            window.location.href = "songs.html";
                          })
                          .catch(error => {
                            console.error(t('songDetail.error.delete'), error);
                            alert(t('songDetail.error.delete'));
                          });
                        }
                      };
                      

                    const formatDate = (date) => {
                        const d = new Date(date);
                        return d.toISOString().split('T')[0]; // "YYYY-MM-DD"
                    };

                    const shareLink = `http://localhost:8080/api/songs/createFromFilePath?` +
                        `name=${encodeURIComponent(song.name)}` +
                        `&album=${encodeURIComponent(song.album)}` +
                        `&artists=${encodeURIComponent(song.artists.join(','))}` +
                        `&genres=${encodeURIComponent(song.genres.join(','))}` +
                        `&duration=${encodeURIComponent(song.duration)}` +
                        `&dateOfRelease=${encodeURIComponent(formatDate(song.dateOfRelease))}` +
                        `&filePath=${encodeURIComponent(song.filePath)}`;

                    document.getElementById("shareBtn").addEventListener("click", () => {
                        navigator.clipboard.writeText(shareLink)
                            .then(() => {
                                alert(t('songDetail.copied.link') + shareLink);
                            })
                            .catch(err => {
                                console.error(t('songDetail.copied.link.error'), err);
                            });
                    });
                })
                .catch(error => {
                    document.getElementById("songDetails").innerText = t('songDetail.error');
                    console.error(error);
                });
        }
    </script>
</body>
</html>
