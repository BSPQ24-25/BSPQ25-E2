<!DOCTYPE html>
<html>
	<head>
        <meta charset="utf-8">
        <title data-i18n="songs.title">Songs - Deuspotify</title>
        <meta name="description" content="Browse all songs">
        <meta name="keywords" content="music, songs, streaming">
        <meta name="author" content="Deuspotify">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Styles -->
        <link href="css/bootstrap.min.css" rel="stylesheet">	
        <link href="css/animate.min.css" rel="stylesheet">
        <link rel="stylesheet" href="css/owl.carousel.css">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <link href="css/style.css" rel="stylesheet">
        <link href="css/style-color.css" rel="stylesheet">
        <link rel="shortcut icon" href="img/logo/favicon.ico">

        <!-- Translation support -->
        <script src="i18n.js"></script>
    </head>
    <body>
        <div class="wrapper" id="home">
            <!-- Header -->
            <header>
                <!-- Secondary menu -->
                <nav class="secondary-menu">
                    <div class="container">
                        <div class="sm-left">
                            <strong data-i18n="index.phone">Phone</strong>: <a href="#">555 555 555</a>
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <strong data-i18n="index.email">E-mail</strong>: <a href="#">info@deuspotify.com</a>
                        </div>
                        <div class="sm-right">
                            <div class="sm-social-link">
                                <a class="h-facebook" href="#"><i class="fa fa-facebook"></i></a>
                                <a class="h-twitter" href="#"><i class="fa fa-twitter"></i></a>
                                <a class="h-google" href="#"><i class="fa fa-google-plus"></i></a>
                                <a class="h-linkedin" href="#"><i class="fa fa-linkedin"></i></a>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </nav>

                <!-- Primary menu -->
                <nav class="navbar navbar-fixed-top navbar-default">
                    <div class="container">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a class="navbar-brand" href="index.html" style="font-size: 24px; font-weight: bold; color: white;">
                                Deuspotify
                            </a>
                        </div>

                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <ul class="nav navbar-nav navbar-right">
                                <li><a href="songs.html" data-i18n="index.viewSongs">View Songs</a></li>
                                <li><a href="favourite_songs.html" data-i18n="index.viewFavouriteSongs">View Favourite Songs</a></li>
                                <li><a href="playlists.html" data-i18n="index.viewPlaylists">View Playlists</a></li>
                                <li><a href="edit_profile.html" data-i18n="index.addeditProfile">Edit Profile</a></li>
                                <li><a href="view_all_playlist.html" data-i18n="index.addview_all_playlist">View All Playlists</a></li>
                                <li><button onclick="logout()" class="logout-button" data-i18n="index.logout">Logout</button></li>
                                <div class="language-selector">
                                    <button onclick="loadTranslations('es')" title="EspaÃ±ol">Es</button>
                                    <button onclick="loadTranslations('en')" title="English">En</button>
                                    <button onclick="loadTranslations('eu')" title="Euskara">Eu</button>
                                </div>
                            </ul>
                        </div>
                    </div>
                </nav>
            </header>

			<!--/ header end -->
			<!-- block for animate navigation menu -->
			<div class="nav-animate"></div>
			
			<!-- Main content -->
			<div class="container pad">
				<div class="row">
					<!-- Sidebar -->
					<div class="col-md-3">
						<div class="sidebar">
							<div class="sidebar-buttons">
								<button onclick="window.location.href='add_song.html'" class="btn btn-theme" data-i18n="songs.add">Add Song</button>
								<button onclick="window.location.href='edit_song.html'" class="btn btn-theme" data-i18n="songs.edit">Edit Song</button>
								<button onclick="window.location.href='delete_song.html'" class="btn btn-theme" data-i18n="songs.delete">Delete Song</button>
								<button onclick="window.location.href='index.html'" class="btn btn-theme" data-i18n="songs.back">Back to Home</button>
							</div>
						</div>
					</div>
					
					<!-- Song list -->
					<div class="col-md-9">
						<h2 data-i18n="songs.titles">Songs</h2>
						<input
							type="text"
							id="searchInput"
							class="search-box"
							data-i18n-placeholder="songs.search"
							placeholder="Search by song name"
						>
						<ul id="songsList" class="list-unstyled"></ul>
					</div>
				</div>
			</div>
			<!--/ Main content end -->
			
			<!-- footer -->
			<footer>
				<div class="container">
					<!-- social media links -->
					<div class="social">
						<a class="h-facebook" href="#"><i class="fa fa-facebook"></i></a>
						<a class="h-google" href="#"><i class="fa fa-google-plus"></i></a>
						<a class="h-linkedin" href="#"><i class="fa fa-linkedin"></i></a>
						<a class="h-twitter" href="#"><i class="fa fa-twitter"></i></a>
					</div>
					<!-- copy right -->
					<p class="copy-right">&copy; <span data-i18n="index.copyright">Copyright</span> 2023, <span data-i18n="index.allRightsReserved">All rights are reserved</span>.</p>
				</div>
			</footer>
			<!-- footer end -->
			
			<!-- Scroll to top -->
			<span class="totop"><a href="#"><i class="fa fa-chevron-up"></i></a></span> 
			
		</div>
		
		<!-- Javascript files -->
		<!-- jQuery -->
		<script src="js/jquery.js"></script>
		<!-- Bootstrap JS -->
		<script src="js/bootstrap.min.js"></script>
		<!-- WayPoints JS -->
		<script src="js/waypoints.min.js"></script>
		<!-- One Page Nav -->
		<script src="js/jquery.nav.js"></script>
		<!-- Respond JS for IE8 -->
		<script src="js/respond.min.js"></script>
		<!-- HTML5 Support for IE -->
		<script src="js/html5shiv.js"></script>
		<!-- Custom JS -->
		<script src="js/custom.js"></script>
		<!-- i18n -->
		<script src="i18n.js"></script>
		
		<script>
		(function() {
			const full = window.location.origin;
			const match = full.match(/^(https?:\/\/[^\/:]+)/);
			const appUrl = match ? match[0] : '';
			const username = localStorage.getItem('username') || '';

			if (!username) {
				console.error('Username is not set. Make sure to store it in localStorage or inject it server-side.');
				return;
			}

			document.addEventListener("DOMContentLoaded", () => {
				loadTranslations();

				let allSongs = [];
				let favIds = new Set();
				let currentAudio = null;
				let currentPlayBtn = null;

				// Load favourites
				fetch(`${appUrl}:8080/api/profiles/${encodeURIComponent(username)}/favourite-songs`)
					.then(res => {
						if (!res.ok) throw new Error('Failed to fetch favourites');
						return res.json();
					})
					.then(favs => {
						favIds = new Set(Array.isArray(favs) ? favs.map(s => s.id) : []);
					})
					.catch(err => console.error(err))
					.finally(() => {
						// Load all songs
						fetch(`${appUrl}:8080/api/songs`)
						.then(response => response.json())
						.then(songs => {
							allSongs = songs;
							renderSongs(songs);
						})
						.catch(console.error);
					});

				function renderSongs(songs) {
					const list = document.getElementById("songsList");
					list.innerHTML = "";

					songs.forEach(song => {
						if (!song.id) return;

						const item = document.createElement("li");
						item.className = "song-item";
						item.id = `song-${song.id}`;

						const playBtn = document.createElement("i");
						playBtn.className = "bi bi-play-circle play-btn";
						playBtn.title = "Play song";

						playBtn.addEventListener("click", () => {
							// If clicking the same song toggle pause/resume
							if (currentAudio && currentPlayBtn === playBtn) {
								if (!currentAudio.paused) {
									currentAudio.pause();
									playBtn.classList.replace('bi-pause-circle', 'bi-play-circle');
								} else {
									currentAudio.play();
									playBtn.classList.replace('bi-play-circle', 'bi-pause-circle');
								}
								return;
							}

							// If another song is playing, stop it and reset its icon
							if (currentAudio && currentPlayBtn) {
								currentAudio.pause();
								currentPlayBtn.classList.replace('bi-pause-circle', 'bi-play-circle');
							}

							// Start new song
							if (song.filePath) {
								currentAudio = new Audio(`/songs_files/${song.filePath}`);
								currentPlayBtn = playBtn;
								currentAudio.play();
								playBtn.classList.replace('bi-play-circle', 'bi-pause-circle');

								currentAudio.onended = () => {
									playBtn.classList.replace('bi-pause-circle', 'bi-play-circle');
									currentAudio = null;
									currentPlayBtn = null;
								};
							}
						});

						const songInfo = document.createElement("div");
						songInfo.className = "song-info";
						
						const songLink = document.createElement("a");
						songLink.href = `detalle_song.html?id=${song.id}`;
						songLink.textContent = song.name;
						songLink.style.fontWeight = "bold";
						
						const artists = document.createElement("p");
						artists.textContent = song.artists?.join(', ') || 'Unknown artist';
						artists.style.margin = "5px 0";
						artists.style.color = "#666";
						
						songInfo.appendChild(songLink);
						songInfo.appendChild(artists);

						const favBtn = document.createElement("i");
						favBtn.className = favIds.has(song.id) ? "bi bi-heart-fill fav-btn favorited" : "bi bi-heart fav-btn";
						favBtn.title = favIds.has(song.id) ? "Remove from favorites" : "Add to favorites";
						
						favBtn.addEventListener("click", () => {
							const isFav = favIds.has(song.id);
							const method = isFav ? 'DELETE' : 'POST';
							fetch(`${appUrl}:8080/api/profiles/${encodeURIComponent(username)}/favourite-songs/${song.id}`, { method })
								.then(resp => {
									if (!resp.ok) throw new Error('Error updating favourite');
									if (isFav) {
										favIds.delete(song.id);
										favBtn.classList.replace('bi-heart-fill','bi-heart');
										favBtn.classList.remove('favorited');
										favBtn.title = "Add to favorites";
									} else {
										favIds.add(song.id);
										favBtn.classList.replace('bi-heart','bi-heart-fill');
										favBtn.classList.add('favorited');
										favBtn.title = "Remove from favorites";
									}
								})
								.catch(console.error);
						});

						const actions = document.createElement("div");
						actions.className = "song-actions";
						actions.appendChild(playBtn);
						actions.appendChild(favBtn);

						item.appendChild(actions);
						item.appendChild(songInfo);
						list.appendChild(item);
					});
				}

				document.getElementById("searchInput").addEventListener("input", function () {
					const searchTerm = this.value.toLowerCase();
					const filteredSongs = allSongs.filter(song =>
						(song.name ?? "").toLowerCase().includes(searchTerm) ||
						(song.artists?.join(' ') ?? "").toLowerCase().includes(searchTerm)
					);
					renderSongs(filteredSongs);
				});
			});

			function logout() {
				localStorage.removeItem("token");
				fetch("/auth/logout", { method: "POST" })
					.then(() => window.location.href = "login.html");
			}
		})();
		</script>
	</body>	
</html>
